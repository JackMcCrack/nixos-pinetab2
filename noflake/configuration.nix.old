{
  config,
  lib,
  pkgs,
  home-manager,
  ...
}:
let
  out =
    ff
    // spec
    // usr
    // {
      _module.args = {
        guestUserName = "guest";
        powerUserHome = "/home/user1";
        powerUserName = "jj";
      };
      environment.etc."nixos/backup/noflake".source = "${./.}";
      environment.etc."nixos/backup/flake.nix".source = "${../flake.nix}";
      environment.systemPackages = [
        pkgs.git
        pkgs.kitty
        pkgs.librewolf
        pkgs.thunderbird
        pkgs.gnomeExtensions.dash-to-dock
        pkgs.vim
      ];
      imports = [
        home-manager.nixosModules.default
        ./default-specialisation.nix
      ];
      nix.settings.experimental-features = [
        "flakes"
        "nix-command"
      ];
      services.displayManager.autoLogin.user = "${config._module.args.guestUserName}";
      services.openssh.enable = true;
      system.stateVersion = "24.05";
      # services.automatic-timezoned.enable = true;
      time.timeZone = "Europe/Amsterdam";
      virtualisation.waydroid.enable = true;
    };
  ff = {
    programs.firefox = {
      enable = true;
      policies = {
        Extensions.Install = [
          "https://addons.mozilla.org/firefox/downloads/latest/i-dont-care-about-cookies/latest.xpi"
          "https://addons.mozilla.org/firefox/downloads/latest/norsk-bokm√•l-ordliste/latest.xpi"
          "https://addons.mozilla.org/firefox/downloads/latest/ublock-origin/latest.xpi"
        ];
        Preferences = {
          "browser.translations.automaticallyPopup".Value = false;
        };
      };
    };
  };
  spec = {
    specialisation = {
      #    budgie.configuration.imports = [./desktops/budgie.nix];
      #    cinnamon.configuration.imports = [./desktops/cinnamon.nix];
      #    enlightenment.configuration.imports = [./desktops/enlightenment.nix];
      gnome-full.configuration.imports = [ ./desktops/gnome.nix ];
      hyprland.configuration.imports = [ ./desktops/hyprland.nix ];
      #    pantheon.configuration.imports = [./desktops/pantheon.nix];
      #    plasma6.configuration.imports = [./desktops/plasma6.nix];
      #    xfce.configuration.imports = [./desktops/xfce.nix];
    };
  };
  usr = {
    users.users = {
      "${config._module.args.guestUserName}" = {
        uid = 1001;
        extraGroups = [ "networkmanager" ];
        hashedPassword = "";
        isNormalUser = true;
      };
      "${config._module.args.powerUserName}" = {
        uid = 1000;
        extraGroups = [
          "wheel"
          "networkmanager"
        ];
        hashedPassword = "$y$j9T$0OWRTLzJzBoKAqfDw3yWo/$gXjqPP6YcmVc52efQxPaNX/yI3Nx8aioRp5PE6G7Ka/";
        home = "${config._module.args.powerUserHome}";
        isNormalUser = true;
      };
    };
    home-manager.users."${config._module.args.guestUserName}" = {
      home.stateVersion = "${config.system.stateVersion}";
      dconf.settings = {
        "com/solus-project/budgie-panel".dark-theme = true;
        "org/cinnamon/desktop/interface".gtk-theme = "Mint-Y-Dark-Aqua";
        "org/gnome/desktop/interface".color-scheme = "prefer-dark";
        "org/gnome/mutter".dynamic-workspaces = true;
        "org/gnome/mutter".edge-tiling = true;
        "org/gnome/settings-daemon/plugins/color".night-light-enabled = true;
        "org/gnome/settings-daemon/plugins/color".night-light-schedule-automatic = false;
        "org/gnome/settings-daemon/plugins/power".sleep-inactive-ac-type = "nothing";
        "org/gnome/shell".enabled-extensions = [
          ""
          "dash-to-dock@micxgx.gmail.com"
          "launch-new-instance@gnome-shell-extensions.gcampax.github.com"
        ];
        "org/gnome/shell".favorite-apps = [ "firefox.desktop" ];
        "org/x/apps/portal".color-scheme = "prefer-dark";
      };
    };
    #  home-manager.users."${config._module.args.powerUserName}".home = {
    #    stateVersion = "${config.system.stateVersion}";
    #  };
  };

  defspec = (
    {
      lib,
      config,
      pkgs,
      ...
    }:
    {
      config = lib.mkIf (config.specialisation != { }) {
        services.xserver.enable = true;
        services.xserver.desktopManager.gnome.enable = true;
        services.xserver.displayManager.gdm.enable = true;
        services.gnome.core-utilities.enable = false;
        environment.gnome.excludePackages = [ pkgs.gnome-tour ];
        services.xserver.excludePackages = [ pkgs.xterm ];
      };
    }
  );
in
out
